!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.mergelive=t()}}(function(){return function t(e,r,n){function o(a,c){if(!r[a]){if(!e[a]){var s="function"==typeof require&&require;if(!c&&s)return s(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var h=r[a]={exports:{}};e[a][0].call(h.exports,function(t){var r=e[a][1][t];return o(r?r:t)},h,h.exports,t,e,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(t,e,r){e.exports={SyncDocument:t("./diffsync/syncdoc").SyncDocument,SyncServer:t("./diffsync/server").SyncServer,SyncHandler:t("./diffsync/handler").SyncHandler}},{"./diffsync/handler":2,"./diffsync/server":3,"./diffsync/syncdoc":4}],2:[function(t,e,r){var n=t("./syncdoc").SyncDocument,o=function(t){if(t=t||{},!t.socket)throw new Error("You must provide a web socket.");this.socket=t.socket,this.get_object=t.get_object,this.oninit=t.oninit||function(t){},this.onchange=t.onchange||function(t){},this.onerror=t.onerror||function(t){console.error(t)},this.document=null,this.socket.onmessage=this.onmessage.bind(this)};o.prototype.require_document=function(){if(!this.document)throw new Error("No document, you must load one first.")},o.prototype.load=function(t,e){this.socket.send(JSON.stringify({type:"load",data:t}),e)},o.prototype.push=function(t){this.require_document(),this.document.push(),this.document.edits.length>0?this.socket.send(JSON.stringify({type:"pull",data:this.document.edits}),t):t&&t()},o.prototype.onmessage=function(t){var e=JSON.parse(t);if(!e.type)throw new Error("Message is missing a type");var r="handle_"+e.type;if(!this[r])throw new Error("Unknown message type: "+e.type);this[r](e.data)},o.prototype.handle_init=function(t){this.document=new n(t),this.oninit()},o.prototype.handle_acknowledge=function(t){this.require_document(),this.document.acknowledge(t)},o.prototype.handle_pull=function(t){this.require_document(),t.forEach(function(t){this.document.pull(t)}.bind(this)),this.onchange(this.document.object)},o.prototype.handle_load=function(t){if(!this.get_object)return void this.socket.send(JSON.stringify({type:"error",data:"No object loader available."}));var e=this.get_object(t);return e?(this.document=new n(e),void this.socket.send(JSON.stringify({type:"init",data:e}))):void this.socket.send(JSON.stringify({type:"error",data:"Object could not be loaded."}))},o.prototype.handle_error=function(t){this.onerror(t)},e.exports={SyncHandler:o}},{"./syncdoc":4}],3:[function(t,e,r){var n=t("./handler").SyncHandler,o=function(t){if(t=t||{},!t.socket)throw new Error("A socket is required.");if(!t.get_object)throw new Error("A `get_object` function is required.");this.get_object=t.get_object,this.socket=t.socket,this.onchange=t.onchange||function(){},this.last_connection_id=0,this.handlers={},this.socket.on("connection",this.onconnection.bind(this))};o.prototype.onconnection=function(t){var e=this.last_connection_id,r=new n({socket:t,get_object:this.get_object,onchange:function(t){this.onchange(t),this.broadcast_change(e,t)}.bind(this)});this.handlers[e]=r,t.on("close",function(){delete this.handlers[e]}.bind(this))},o.prototype.broadcast_change=function(t){Object.keys(this.handlers,function(e){if(e!=t){var r=this.handlers[e];r&&r.push()}}.bind(this))},e.exports={SyncServer:o}},{"./handler":2}],4:[function(t,e,r){var n=t("jiff"),o=n.diff,i=n.patch,a=function(t){return JSON.parse(JSON.stringify(t))},c=function(t){this.object=t,this.shadow={version:0,other_version:0,object:a(t)},this.backup={version:0,object:a(t)},this.edits=[]};c.prototype.push=function(){var t=o(this.shadow.object,this.object);if(0!=t.length){var e={version:this.shadow.version,other_version:this.shadow.other_version,delta:t};this.backup.object=this.shadow.object,this.backup.version=this.shadow.version,this.shadow.object=a(this.object),this.shadow.version++,this.edits.push(e)}},c.prototype.pull=function(t){if(!t.delta)return void this.acknowledge(t.other_version);if(!(t.version<this.shadow.other_version)){if(t.other_version!=this.shadow.version)return void this.rollback();this.shadow.object=i(t.delta,this.shadow.object),this.shadow.other_version=t.version+1;try{this.object=i(t.delta,this.object)}catch(e){this.push()}this.acknowledge(t.other_version)}},c.prototype.acknowledge=function(t){this.edits=this.edits.filter(function(e){return t<e.version})},c.prototype.rollback=function(t){this.edits=[],this.shadow.object=a(this.backup.object),this.shadow.version=this.backup.version,this.pull(t)},c.prototype.receipt=function(){return this.shadow.other_version},e.exports={SyncDocument:c}},{jiff:5}],5:[function(t,e,r){function n(t,e,r){return i(t,e,"",o(r,[])).patch}function o(t,e){return"object"==typeof t?{patch:e,hash:h(f,t.hash,w),makeContext:h(f,t.makeContext,p)}:{patch:e,hash:h(f,t,w),makeContext:p}}function i(t,e,r,n){return Array.isArray(t)&&Array.isArray(e)?c(t,e,r,n):g(t)&&g(e)?a(t,e,r,n):u(t,e,r,n)}function a(t,e,r,n){var o,a,c=Object.keys(e),s=n.patch;for(o=c.length-1;o>=0;--o){a=c[o];var u=r+"/"+b(a);void 0!==t[a]?i(t[a],e[a],u,n):s.push({op:"add",path:u,value:e[a]})}for(c=Object.keys(t),o=c.length-1;o>=0;--o)if(a=c[o],void 0===e[a]){var h=r+"/"+b(a);s.push({op:"test",path:h,value:t[a]}),s.push({op:"remove",path:h})}return n}function c(t,e,r,n){var o=d.map(n.hash,t),i=d.map(n.hash,e),a=l.compare(o,i);return s(t,e,r,n,a)}function s(t,e,r,n,o){var a=0;return l.reduce(function(n,o,c,s){var u,h,p=n.patch,f=r+"/"+(s+a);return o===l.REMOVE?(u=p[p.length-1],h=n.makeContext(s,t),p.push({op:"test",path:f,value:t[s],context:h}),void 0!==u&&"add"===u.op&&u.path===f?(u.op="replace",u.context=h):p.push({op:"remove",path:f,context:h}),a-=1):o===l.ADD?(p.push({op:"add",path:f,value:e[c],context:n.makeContext(s,t)}),a+=1):i(t[s],e[c],f,n),n},n,o)}function u(t,e,r,n){return t!==e&&(n.patch.push({op:"test",path:r,value:t}),n.patch.push({op:"replace",path:r,value:e})),n}function h(t,e,r){return t(e)?e:r}function p(){return void 0}function f(t){return"function"==typeof t}var l=t("./lib/lcs"),d=t("./lib/array"),v=t("./lib/jsonPatch"),y=t("./lib/inverse"),m=t("./lib/jsonPointer"),b=m.encodeSegment;r.diff=n,r.patch=v.apply,r.patchInPlace=v.applyInPlace,r.inverse=y,r.clone=v.clone,r.InvalidPatchOperationError=t("./lib/InvalidPatchOperationError"),r.TestFailedError=t("./lib/TestFailedError"),r.PatchNotInvertibleError=t("./lib/PatchNotInvertibleError");var g=v.isValidObject,w=v.defaultHash},{"./lib/InvalidPatchOperationError":6,"./lib/PatchNotInvertibleError":7,"./lib/TestFailedError":8,"./lib/array":9,"./lib/inverse":13,"./lib/jsonPatch":14,"./lib/jsonPointer":15,"./lib/lcs":17}],6:[function(t,e,r){function n(t){Error.call(this),this.name=this.constructor.name,this.message=t,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}e.exports=n,n.prototype=Object.create(Error.prototype),n.prototype.constructor=n},{}],7:[function(t,e,r){function n(t){Error.call(this),this.name=this.constructor.name,this.message=t,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}e.exports=n,n.prototype=Object.create(Error.prototype),n.prototype.constructor=n},{}],8:[function(t,e,r){function n(t){Error.call(this),this.name=this.constructor.name,this.message=t,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}e.exports=n,n.prototype=Object.create(Error.prototype),n.prototype.constructor=n},{}],9:[function(t,e,r){function n(t,e){var r=e.length,n=new Array(r+1);n[0]=t;for(var o=0;r>o;++o)n[o+1]=e[o];return n}function o(t){for(var e=t.length-1,r=new Array(e),n=0;e>n;++n)r[n]=t[n+1];return r}function i(t,e){for(var r=new Array(e.length),n=0;n<e.length;++n)r[n]=t(e[n]);return r}r.cons=n,r.tail=o,r.map=i},{}],10:[function(t,e,r){function n(t){return null==t||"object"!=typeof t?t:Array.isArray(t)?o(t):i(t)}function o(t){for(var e=t.length,r=new Array(e),o=0;e>o;++o)r[o]=n(t[o]);return r}function i(t){for(var e,r=Object.keys(t),o={},i=0,a=r.length;a>i;++i)e=r[i],o[e]=n(t[e]);return o}e.exports=n},{}],11:[function(t,e,r){function n(t,e,r,n){if(t.path===r.path)throw new TypeError("cannot commute "+t.op+","+r.op+" with identical object paths");return[r,t]}function o(t,e,r,n){return e.length===n.length?a(t,e,r,n):(e.length>n.length?(e=c(r,n,t,e,-1),t.path=h.absolute(h.join(e))):(n=c(t,e,r,n,1),r.path=h.absolute(h.join(n))),[r,t])}function i(t,e,r){return h.isValidArrayIndex(t[r])&&h.isValidArrayIndex(e[r])}function a(t,e,r,n){var o,i=e.length-1,a=+e[i],c=+n[i];return c>a?"add"===t.op||"copy"===t.op?(o=n.slice(),o[i]=Math.max(0,c-1),r.path=h.absolute(h.join(o))):"remove"===t.op&&(o=n.slice(),o[i]=c+1,r.path=h.absolute(h.join(o))):"add"===r.op||"copy"===r.op?(o=e.slice(),o[i]=a+1,t.path=h.absolute(h.join(o))):a>c&&"remove"===r.op&&(o=e.slice(),o[i]=Math.max(0,a-1),t.path=h.absolute(h.join(o))),[r,t]}function c(t,e,r,n,o){var i=e.length-1,a=+e[i],c=+n[i],s=n.slice();return a>c?s:("add"===t.op||"copy"===t.op?s[i]=Math.max(0,c-o):"remove"===t.op&&(s[i]=Math.max(0,c+o)),s)}function s(t,e){var r=t.length,n=e.length;if(0===r||0===n||2>r&&2>n)return[];for(var o=r===n?r-1:Math.min(r,n),i=0;o>i&&t[i]===e[i];)++i;return t.slice(0,i)}function u(t){return"remove"===t.op?{op:t.op,path:t.path}:"copy"===t.op||"move"===t.op?{op:t.op,path:t.path,from:t.from}:{op:t.op,path:t.path,value:t.value}}var h=t("./jsonPointer");e.exports=function(t,e){var r=h.parse(t.path),a=h.parse(e.path),c=s(r,a),p=i(r,a,c.length),f=u(t),l=u(e);return 0!==c.length||p?p?o(f,r,l,a):n(f,r,l,a):[l,f]}},{"./jsonPointer":15}],12:[function(t,e,r){function n(t,e){return t===e?!0:Array.isArray(t)&&Array.isArray(e)?o(t,e):"object"==typeof t&&"object"==typeof e?i(t,e):!1}function o(t,e){if(t.length!==e.length)return!1;for(var r=0;r<t.length;++r)if(!n(t[r],e[r]))return!1;return!0}function i(t,e){if(null===t&&null!==e||null!==t&&null===e)return!1;var r=Object.keys(t),o=Object.keys(e);if(r.length!==o.length)return!1;for(var i,a=0;a<r.length;++a)if(i=r[a],!(i in e&&n(t[i],e[i])))return!1;return!0}e.exports=n},{}],13:[function(t,e,r){function n(t,e,r,n){var i=o[e.op];return void 0!==i&&"function"==typeof i.inverse?i.inverse(t,e,r,n):1}var o=t("./patches");e.exports=function(t){var e,r,o=[];for(e=t.length-1;e>=0;e-=r)r=n(o,t[e],e,t);return o}},{"./patches":18}],14:[function(t,e,r){function n(t,e,r){return o(t,s(e),r)}function o(t,e,r){if(r||(r=h),!Array.isArray(t))return e;for(var n,o,i=0;i<t.length;++i){if(o=t[i],n=c[o.op],void 0===n)throw new u("invalid op "+JSON.stringify(o));e=n.apply(e,o,r)}return e}function i(t){return a(t)?JSON.stringify(t):t}function a(t){return null!==t&&"object"==typeof t}var c=t("./patches"),s=t("./clone"),u=t("./InvalidPatchOperationError");r.apply=n,r.applyInPlace=o,r.clone=s,r.isValidObject=a,r.defaultHash=i;var h={}},{"./InvalidPatchOperationError":6,"./clone":10,"./patches":18}],15:[function(t,e,r){function n(t,e,r,n){if("string"==typeof e){if(""===e)return{target:t,key:void 0};if(e===d)return{target:t,key:""};var o,i=t,a=void 0!==n;return l(e,function(e){return null==t?(i=null,!1):(o=Array.isArray(t)?a?f(r,p(e),t,n):"-"===e?e:p(e):e,i=t,void(t=t[o]))}),null===i?void 0:{target:i,key:o}}}function o(t){return t[0]===d?t:d+t}function i(t){return t.join(d)}function a(t){var e=[];return l(t,e.push.bind(e)),e}function c(t,e){return 0===e.indexOf(t)&&e[t.length]===d}function s(t){return t.replace(m,d).replace(x,b)}function u(t){return t.replace(g,w).replace(v,y)}function h(t){return k.test(t)}function p(t){if(h(t))return+t;throw new SyntaxError("invalid array index "+t)}function f(t,e,r,n){var o=e;if(0>o)throw new Error("array index out of bounds "+o);if(void 0!==n&&"function"==typeof t&&(o=t(e,r,n),0>o))throw new Error("could not find patch context "+n);return o}var l=t("./jsonPointerParse");r.find=n,r.join=i,r.absolute=o,r.parse=a,r.contains=c,r.encodeSegment=u,r.decodeSegment=s,r.parseArrayIndex=p,r.isValidArrayIndex=h;var d="/",v=/\//g,y="~1",m=/~1/g,b="~",g=/~/g,w="~0",x=/~0/g,k=/^(0|[1-9]\d*)$/},{"./jsonPointerParse":16}],16:[function(t,e,r){function n(t,e){var r,n,s,u;for(r=t.charAt(0)===i?1:0,n="",o.lastIndex=r;s=o.exec(t);)if(u=s[0],n+=t.slice(r,o.lastIndex-u.length),r=o.lastIndex,u===i){if(e(n)===!1)return t;n=""}else n+=u===c?i:a;return n+=t.slice(r),e(n),t}e.exports=n;var o=/\/|~1|~0/g,i="/",a="~",c="~1"},{}],17:[function(t,e,r){function n(t,e){var r=t.length,n=e.length,o=i(t,e),u=r>o&&n>o?a(t,e,o):0,h=u+o-1;r-=h,n-=h;for(var p=s(r,n),f=r-1;f>=0;--f)for(var l=n-1;l>=0;--l)p[l][f]=c(p,t,e,o,f,l);return{prefix:o,matrix:p,suffix:u}}function o(t,e,r){var n,o,i,a,c=r.matrix,s=r.prefix;for(n=0;s>n;++n)e=t(e,l,n,n);for(i=n,s=c.length,n=0,o=0;s>n;)switch(a=c[n][o].type,e=t(e,a,n+i,o+i),a){case l:++n,++o;break;case h:++o;break;case f:++n}for(n+=i,o+=i,s=r.suffix,i=0;s>i;++i)e=t(e,l,n+i,o+i);return e}function i(t,e){for(var r=0,n=Math.min(t.length,e.length);n>r&&t[r]===e[r];)++r;return r}function a(t,e){for(var r=t.length-1,n=e.length-1,o=Math.min(r,n),i=0;o>i&&t[r-i]===e[n-i];)++i;return i}function c(t,e,r,n,o,i){return e[o+n]===r[i+n]?{value:t[i+1][o+1].value,type:l}:t[i][o+1].value<t[i+1][o].value?{value:t[i][o+1].value+1,type:h}:{value:t[i+1][o].value+1,type:f}}function s(t,e){var r,n,o,i=[];for(o=i[e]=[],n=0;t>n;++n)o[n]={value:t-n,type:h};for(r=0;e>r;++r)i[r]=[],i[r][t]={value:e-r,type:f};return i[e][t]={value:0,type:l},i}r.compare=n,r.reduce=o;var u,h,p,f,l;r.REMOVE=u=h=-1,r.ADD=p=f=1,r.EQUAL=l=0},{}],18:[function(t,e,r){function n(t,e,r){var n,o,i=T(t,e.path,r.findContext,e.context),a=i.target;if(Array.isArray(a)?(n=q(i.key),o=a[n]):o=void 0===i.key?i.target:i.target[i.key],!O(o,e.value))throw new I("test failed "+JSON.stringify(e));return t}function o(t,e){return t.push(e),1}function i(t,e){if(t.path===e.path&&"remove"===e.op)throw new TypeError("Can't commute test,remove -> remove,test for same path");return"test"===e.op||"replace"===e.op?[e,t]:S(t,e)}function a(t,e,r){var n=T(t,e.path,r.findContext,e.context);if(k(n))throw new C("path does not exist "+e.path);var o=_(e.value);return void 0===n.key?o:(c(n,o),t)}function c(t,e){var r=t.target;if(Array.isArray(r))"-"===t.key?r.push(e):r.splice(t.key,0,e);else{if(!E(r))throw new C("target of add must be an object or array "+t.key);r[t.key]=e}}function s(t,e){var r=e.context;return void 0!==r&&(r={before:r.before,after:P.cons(e.value,r.after)}),t.push({op:"test",path:e.path,value:e.value,context:r}),t.push({op:"remove",path:e.path,context:r}),1}function u(t,e){if(t.path===e.path&&"remove"===e.op)throw new TypeError("Can't commute add,remove -> remove,add for same path");return S(t,e)}function h(t,e,r){var n=T(t,e.path,r.findContext,e.context);if(k(n)||j(n))throw new C("path does not exist "+e.path);var o=_(e.value);if(void 0===n.key)return o;var i=n.target;return Array.isArray(i)?i[q(n.key)]=o:i[n.key]=o,t}function p(t,e,r,n){var o=n[r-1];if(void 0===o||"test"!==o.op||o.path!==e.path)throw new N("cannot invert replace w/o test");var i=o.context;return void 0!==i&&(i={before:i.before,after:P.cons(o.value,P.tail(i.after))}),t.push({op:"test",path:o.path,value:e.value}),t.push({op:"replace",path:o.path,value:o.value}),2}function f(t,e){if(t.path===e.path&&"remove"===e.op)throw new TypeError("Can't commute replace,remove -> remove,replace for same path");return"test"===e.op||"replace"===e.op?[e,t]:S(t,e)}function l(t,e,r){var n=T(t,e.path,r.findContext,e.context);if(k(n)||void 0===n.target[n.key])throw new C("path does not exist "+e.path);return d(n),t}function d(t){var e,r=t.target;if(Array.isArray(r))return e=r.splice(q(t.key),1),e[0];if(E(r))return e=r[t.key],delete r[t.key],e;throw new C("target of remove must be an object or array")}function v(t,e,r,n){var o=n[r-1];if(void 0===o||"test"!==o.op||o.path!==e.path)throw new N("cannot invert remove w/o test");var i=o.context;return void 0!==i&&(i={before:i.before,after:P.tail(i.after)}),t.push({op:"add",path:o.path,value:o.value,context:i}),2}function y(t,e){return t.path===e.path&&"remove"===e.op?[e,t]:S(t,e)}function m(t,e,r){if(A.contains(e.path,e.from))throw new C("move.from cannot be ancestor of move.path");var n=T(t,e.path,r.findContext,e.context),o=T(t,e.from,r.findContext,e.fromContext);return c(n,d(o)),t}function b(t,e){return t.push({op:"move",path:e.from,context:e.fromContext,from:e.path,fromContext:e.context}),1}function g(t,e){if(t.path===e.path&&"remove"===e.op)throw new TypeError("Can't commute move,remove -> move,replace for same path");return S(t,e)}function w(t,e,r){var n=T(t,e.path,r.findContext,e.context),o=T(t,e.from,r.findContext,e.fromContext);if(k(o)||j(o))throw new C("copy.from must exist");var i,a=o.target;return i=Array.isArray(a)?a[q(o.key)]:a[o.key],c(n,_(i)),t}function x(t,e){throw new N("cannot invert "+e.op)}function k(t){return void 0===t||null==t.target&&void 0!==t.key}function j(t){return void 0!==t.key&&void 0===t.target[t.key]}function E(t){return null!==t&&"object"==typeof t}var A=t("./jsonPointer"),_=t("./clone"),O=t("./deepEquals"),S=t("./commutePaths"),P=t("./array"),I=t("./TestFailedError"),C=t("./InvalidPatchOperationError"),N=t("./PatchNotInvertibleError"),T=A.find,q=A.parseArrayIndex;r.test={apply:n,inverse:o,commute:i},r.add={apply:a,inverse:s,commute:u},r.remove={apply:l,inverse:v,commute:y},r.replace={apply:h,inverse:p,commute:f},r.move={apply:m,inverse:b,commute:g},r.copy={apply:w,inverse:x,commute:u}},{"./InvalidPatchOperationError":6,"./PatchNotInvertibleError":7,"./TestFailedError":8,"./array":9,"./clone":10,"./commutePaths":11,"./deepEquals":12,"./jsonPointer":15}]},{},[1])(1)});
//# sourceMappingURL=mergelive.min.js.map
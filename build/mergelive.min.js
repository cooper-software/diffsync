!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.mergelive=t()}}(function(){return function t(e,o,n){function i(r,c){if(!o[r]){if(!e[r]){var h="function"==typeof require&&require;if(!c&&h)return h(r,!0);if(s)return s(r,!0);var d=new Error("Cannot find module '"+r+"'");throw d.code="MODULE_NOT_FOUND",d}var a=o[r]={exports:{}};e[r][0].call(a.exports,function(t){var o=e[r][1][t];return i(o?o:t)},a,a.exports,t,e,o,n)}return o[r].exports}for(var s="function"==typeof require&&require,r=0;r<n.length;r++)i(n[r]);return i}({1:[function(t,e,o){e.exports={SyncDocument:t("./diffsync/syncdoc").SyncDocument,SyncServer:t("./diffsync/server").SyncServer,SyncHandler:t("./diffsync/handler").SyncHandler}},{"./diffsync/handler":2,"./diffsync/server":3,"./diffsync/syncdoc":4}],2:[function(t,e,o){var n=t("./syncdoc").SyncDocument,i=function(t){if(t=t||{},!t.socket)throw new Error("You must provide a web socket.");this.socket=t.socket,this.get_object=t.get_object,this.oninit=t.oninit||function(t){},this.onchange=t.onchange||function(t){},this.onerror=t.onerror||function(t){console.error(t)},this.document=null,this.socket.on("message",this.onmessage.bind(this))};i.prototype.require_document=function(){if(!this.document)throw new Error("No document, you must load one first.")},i.prototype.load=function(t,e){this.socket.send(JSON.stringify({type:"load",data:t}),e)},i.prototype.push=function(t){this.require_document(),this.document.push(),this.document.edits.length>0?this.socket.send(JSON.stringify({type:"pull",data:this.document.edits}),t):t&&t()},i.prototype.onmessage=function(t){var e=JSON.parse(t);if(!e.type)throw new Error("Message is missing a type");var o="handle_"+e.type;if(!this[o])throw new Error("Unknown message type: "+e.type);this[o](e.data)},i.prototype.handle_init=function(t){this.document=new n(t),this.oninit()},i.prototype.handle_acknowledge=function(t){this.require_document(),this.document.acknowledge(t)},i.prototype.handle_pull=function(t){this.require_document(),t.forEach(function(t){this.document.pull(t)}.bind(this)),this.onchange(this.document.object)},i.prototype.handle_load=function(t){if(!this.get_object)return void this.socket.send(JSON.stringify({type:"error",data:"No object loader available."}));var e=this.get_object(t);return e?(this.document=new n(e),void this.socket.send(JSON.stringify({type:"init",data:e}))):void this.socket.send(JSON.stringify({type:"error",data:"Object could not be loaded."}))},i.prototype.handle_error=function(t){this.onerror(t)},e.exports={SyncHandler:i}},{"./syncdoc":4}],3:[function(t,e,o){var n=t("./handler").SyncHandler,i=function(t){if(t=t||{},!t.socket)throw new Error("A socket is required.");if(!t.get_object)throw new Error("A `get_object` function is required.");this.get_object=t.get_object,this.socket=t.socket,this.onchange=t.onchange||function(){},this.last_connection_id=0,this.handlers={},this.socket.on("connection",this.onconnection.bind(this))};i.prototype.onconnection=function(t){var e=this.last_connection_id,o=new n({socket:t,get_object:this.get_object,onchange:function(t){this.onchange(t),this.broadcast_change(e,t)}.bind(this)});this.handlers[e]=o,t.on("close",function(){delete this.handlers[e]}.bind(this))},i.prototype.broadcast_change=function(t){Object.keys(this.handlers,function(e){if(e!=t){var o=this.handlers[e];o&&o.push()}}.bind(this))},e.exports={SyncServer:i}},{"./handler":2}],4:[function(t,e,o){var n=t("jiff"),i=n.diff,s=n.patch,r=function(t){return JSON.parse(JSON.stringify(t))},c=function(t){this.object=t,this.shadow={version:0,other_version:0,object:r(t)},this.backup={version:0,object:r(t)},this.edits=[]};c.prototype.push=function(){var t=i(this.shadow.object,this.object);if(0!=t.length){var e={version:this.shadow.version,other_version:this.shadow.other_version,delta:t};this.backup.object=this.shadow.object,this.backup.version=this.shadow.version,this.shadow.object=r(this.object),this.shadow.version++,this.edits.push(e)}},c.prototype.pull=function(t){if(!t.delta)return void this.acknowledge(t.other_version);if(!(t.version<this.shadow.other_version)){if(t.other_version!=this.shadow.version)return void this.rollback();this.shadow.object=s(t.delta,this.shadow.object),this.shadow.other_version=t.version+1;try{this.object=s(t.delta,this.object)}catch(e){this.push()}this.acknowledge(t.other_version)}},c.prototype.acknowledge=function(t){this.edits=this.edits.filter(function(e){return t<e.version})},c.prototype.rollback=function(t){this.edits=[],this.shadow.object=r(this.backup.object),this.shadow.version=this.backup.version,this.pull(t)},c.prototype.receipt=function(){return this.shadow.other_version},e.exports={SyncDocument:c}},{jiff:void 0}]},{},[1])(1)});
//# sourceMappingURL=mergelive.min.js.map